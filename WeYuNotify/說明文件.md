* * *

# WeYuNotifybot – Telegram Bot 快速上手

> 目標：建立一隻 Telegram Bot、拿到 **API Token** 與 **Chat ID**，並完成第一則訊息發送

* * *

## 1. 建立 Bot（透過 BotFather）

1. 在 Telegram 搜尋並開啟 **@BotFather**
2. 與 BotFather 對話，輸入：
    ```
    /start
    /newbot
    ```
3. 依序輸入：

    * **顯示名稱**（可中文，例如：`WeYuNotifybot`）
    * **機器人帳號**（必須以 `bot` 結尾，例如：`weYu_notify_bot`）

完成後，BotFather 會回傳一段 **API Token**，長相如下：

```
123456789:ABCDefGhIJKlmNoPQRstuVwxyZ
```

* * *

## 2. 啟動對話，讓 Telegram 產生更新紀錄

> 目的：讓 `getUpdates` 有可讀的對話資料，才能抓到 **chat.id**

* 把你建立好的 Bot **拉進一個聊天室**（群組或私聊都可），  
  或者直接 **私訊你的 Bot** 一段文字（例如：`/start`）。
* * *

## 3. 取得 Chat ID（使用 getUpdates）

開瀏覽器到以下網址（把 `<YOUR_TOKEN>` 換成你的 Token）：

```
https://api.telegram.org/bot<YOUR_TOKEN>/getUpdates
```

範例（像以下這樣）：

```
https://api.telegram.org/bot8125845932:AAHz6jjgR9D_4VlOOPLLSoaDghk9lKuNWEE/getUpdates
```

你會看到一段 JSON，像這樣：

```json
{
  "ok": true,
  "result": [
    {
      "update_id": 639714300,
      "message": {
        "message_id": 105,
        "from": {
          "id": 7547522670,
          "is_bot": false,
          "first_name": "zhen",
          "last_name": "yang",
          "language_code": "zh-hans"
        },
        "chat": {
          "id": 7547522670,
          "first_name": "zhen",
          "last_name": "yang",
          "type": "private"
        },
        "date": 1756276449,
        "text": "/start"
      }
    }
  ]
}
```

* **私聊 Chat ID**：`result[0].message.chat.id`（上例為 `7547522670`）
* **群組 Chat ID**：通常是負數（例如 `-1001234567890`）。請先把 Bot 加入群組，並在群組裡發一句話，再查看 `getUpdates`。

> 若 `getUpdates` 沒內容：請確保你**已經傳過訊息**（或群組有人講話）給該 Bot。

* * *

## 4. 呼叫 WeYuTelegramAPI

### Endpoint

```
GET https://cloud.weyutech.com/TelegramNotify/api/notify/telegram

快速測試Api端點是否活著
GET https://10.0.20.29/TelegramNotify/api/notify/telegram?chatid=1654836210&BotToken=8125845932:AAHz6jjgR9D_4VlOOPLLSoaDghk9lKuNWEE&subject=test&body=ok&SecretKey=DT8DLw4/Nj89KDszGyoz
```

### Query 參數

| 參數 | 必填 | 說明 |
| --- | --- | --- |
| `SecretKey` | ✅ | 管理員提供的混淆字串（用於授權）。預設明文是 `WeYuTelegramApi` 的混淆結果，**值**：`DT8DLw4/Nj89KDszGyoz` |
| `BotToken` | ✅ | BotFather 給的 Token |
| `ChatId` | ✅ | 目標聊天室 ID（私聊或群組） |
| `Subject` | ✅ | 訊息標題（會用 `<b>…</b>` 粗體顯示） |
| `Body` | ✅ | 訊息內容；支援 `parse_mode=HTML`（可用 `<b>`、`<i>` 等），系統會自動切段避免超過 4096 字 |
| `tokens.<KEY>` | － | 替換模板的動態變數。訊息中的 `{{KEY}}` 會被對應值取代（未提供的 token 會原樣保留） |

#### 內建可用 token (如果有需要可以顯示出來)

* `{{Now}}`：UTC ISO-8601 時間（例：`2025-08-28T05:21:33.123Z`）
* `{{ChatId}}`：當前請求的 ChatId

### 範例 URL

```
https://cloud.weyutech.com/TelegramNotify/api/notify/telegram?chatid=1654836210&BotToken=8125845932:AAHz6jjgR9D_4VlOOPLLSoaDghk9lKuNWEE&subject=設備異常通知%20-%20EQP-7F-021&body=建議處置%EF%BC%9A%7B%7BACTION_SUGGEST%7D%7D%0A時間%EF%BC%9A%7B%7BNow%7D%7D%0A&tokens.ACTION_SUGGEST=立即停機檢查油壓泵，聯絡設備工程&SecretKey=DT8DLw4/Nj89KDszGyoz
```

## 5. 詳細說明

基本格式

```http
GET /api/notify/telegram
  ?SecretKey=<管理員給的 SecretKey>
  &ChatId=<目標 ChatId>
  &BotToken=<BotFather 給的 Token>
  &Subject=<訊息主旨>
  &Body=<訊息內容，可含 {{Token}}>
  &tokens.<TokenName>=<替換內容>
```

* * *

Tokens 替換範例

### 請求 URL

```http
https://cloud.weyutech.com/TelegramNotify/api/notify/telegram
  ?SecretKey=DT8DLw4/Nj89KDszGyoz
  &ChatId=1654836210
  &BotToken=8125845932:AAHz6jjgR9D_4VlOOPLLSoaDghk9lKuNWEE
  &Body=這是訊息主旨%20%EF%BC%9A%7B%7B保留字串%7D%7D%0A
  &tokens.保留字串=訊息內容
```


* 你可以在 `Subject` / `Body` 使用 `{{KEY}}` 占位符。
* 透過 Query 傳 `tokens.KEY=value` 完成替換。
* 未提供的 Key 會保留原樣（方便除錯）。
* 內建 `{{Now}}` 與 `{{ChatId}}` 可直接使用。
```
body=這是訊息主旨 %EF%BC%9A%7B%7B 保留字串 %7D%7D%0A & tokens.保留字串 = 訊息內容
```

* * *

常見字元 URL Encode 對照表

| 字元 | Encode 後 |
| --- | --- |
| 空白 | `%20` |
| ： | `%EF%BC%9A` |
| {{ | `%7B%7B` |
| }} | `%7D%7D` |
| 換行 | `%0A` |

> 建議：用工具或GPT自動處理，避免手動漏掉，整個MD丟給它就知道要怎麼做了

* * *

懶人包直接可用範例

```http
https://cloud.weyutech.com/TelegramNotify/api/notify/telegram
  ?SecretKey=DT8DLw4/Nj89KDszGyoz
  &ChatId=1654836210
  &BotToken=8125845932:AAHz6jjgR9D_4VlOOPLLSoaDghk9lKuNWEE
  &Subject=設備異常通知
  &Body=請立即處理：%7B%7BACTION_SUGGEST%7D%7D%0A
  &tokens.ACTION_SUGGEST=立即停機檢查油壓泵
```

## 6. 回應格式

### 成功 `200 OK`

```json
{
    "message": "sent",
    "subject": "設備異常通知 - EQP-7F-021",
    "body": "建議處置：立即停機檢查油壓泵，聯絡設備工程\n時間：2025-08-28T02:11:04.8981625Z\n",
    "logId": "dac9eecb-2650-429e-8bae-13b2157be84e"
}
```

## 7. 常見問題（FAQ）

**Q：為什麼我 GET 成功，但 Telegram 收不到？**  
A：檢查 `BotToken` 是否正確、Bot 是否有被加入聊天室、`ChatId` 是否填成私聊 ID 或群組 ID（群組多為負數）。先在群組講話，再查一次 `getUpdates`

**Q：`未授權`？**  
A：`SecretKey` 沒帶對。請用上面提供的 `DT8DLw4/Nj89KDszGyoz`

**Q：`+`、`/`、`=` 在 URL 會出事嗎？**  
A：會，請用 URL Encode

**Q：訊息太長？**  
A：系統會自動切段避免超過 Telegram 4096 字上限